<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>WebSocket Test Page</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      line-height: 1.6;
      color: #333;
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
    }
    h1 {
      text-align: center;
      margin-bottom: 30px;
    }
    .container {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
    }
    .panel {
      border: 1px solid #ddd;
      border-radius: 5px;
      padding: 15px;
      background: #f9f9f9;
    }
    .controls {
      margin-bottom: 20px;
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }
    button {
      padding: 8px 15px;
      border: none;
      border-radius: 5px;
      background: #4a90e2;
      color: white;
      cursor: pointer;
      transition: background 0.3s;
    }
    button:hover {
      background: #357abD;
    }
    button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    button.disconnect {
      background: #e74c3c;
    }
    button.disconnect:hover {
      background: #c0392b;
    }
    input {
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 5px;
      flex-grow: 1;
    }
    #connection-status {
      font-weight: bold;
      margin-bottom: 10px;
      padding: 8px;
      border-radius: 5px;
      text-align: center;
    }
    .connected {
      background: #e6ffe6;
      color: #006600;
    }
    .disconnected {
      background: #ffe6e6;
      color: #e60000;
    }
    .log-container {
      height: 300px;
      overflow-y: auto;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 5px;
      background: #fff;
    }
    .log-entry {
      margin-bottom: 5px;
      padding: 5px;
      border-bottom: 1px solid #eee;
    }
    .timestamp {
      color: #666;
      font-size: 0.8em;
    }
    .send-controls {
      display: flex;
      gap: 10px;
      margin-top: 15px;
    }
  </style>
</head>
<body>
  <h1>WebSocket Test Page</h1>
  
  <div id="connection-status" class="disconnected">Disconnected</div>
  
  <div class="controls">
    <button id="connect-btn">Connect</button>
    <button id="disconnect-btn" class="disconnect" disabled>Disconnect</button>
    <input type="number" id="user-id-input" placeholder="Enter User ID for authentication" value="1"/>
  </div>
  
  <div class="container">
    <div class="panel">
      <h3>Connection Log</h3>
      <div id="connection-log" class="log-container"></div>
    </div>
    
    <div class="panel">
      <h3>Message Log</h3>
      <div id="message-log" class="log-container"></div>
      
      <div class="send-controls">
        <input type="number" id="recipient-id-input" placeholder="Recipient ID" value="2"/>
        <input type="text" id="message-input" placeholder="Type a message..."/>
        <button id="send-btn" disabled>Send</button>
      </div>
    </div>
  </div>

  <script>
    // DOM Elements
    const connectBtn = document.getElementById('connect-btn');
    const disconnectBtn = document.getElementById('disconnect-btn');
    const userIdInput = document.getElementById('user-id-input');
    const recipientIdInput = document.getElementById('recipient-id-input');
    const messageInput = document.getElementById('message-input');
    const sendBtn = document.getElementById('send-btn');
    const connectionStatus = document.getElementById('connection-status');
    const connectionLog = document.getElementById('connection-log');
    const messageLog = document.getElementById('message-log');
    
    // WebSocket reference
    let socket = null;
    
    // Add log entry with timestamp
    function addLog(container, message) {
      const now = new Date();
      const timestamp = now.toLocaleTimeString();
      const entry = document.createElement('div');
      entry.className = 'log-entry';
      entry.innerHTML = `<span class="timestamp">[${timestamp}]</span> ${message}`;
      container.appendChild(entry);
      container.scrollTop = container.scrollHeight;
    }
    
    // Update connection status UI
    function updateConnectionStatus(connected) {
      if (connected) {
        connectionStatus.textContent = 'Connected';
        connectionStatus.className = 'connected';
        connectBtn.disabled = true;
        disconnectBtn.disabled = false;
        sendBtn.disabled = false;
      } else {
        connectionStatus.textContent = 'Disconnected';
        connectionStatus.className = 'disconnected';
        connectBtn.disabled = false;
        disconnectBtn.disabled = true;
        sendBtn.disabled = true;
      }
    }
    
    // Connect to WebSocket server
    connectBtn.addEventListener('click', () => {
      const userId = parseInt(userIdInput.value);
      
      if (isNaN(userId) || userId <= 0) {
        alert('Please enter a valid user ID');
        return;
      }
      
      try {
        // Determine protocol based on page protocol
        const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        const wsUrl = `${protocol}//${window.location.host}/ws`;
        
        addLog(connectionLog, `Connecting to ${wsUrl}...`);
        
        socket = new WebSocket(wsUrl);
        
        // Connection opened
        socket.addEventListener('open', () => {
          addLog(connectionLog, 'Connection established');
          updateConnectionStatus(true);
          
          // Send authentication message
          const authMessage = {
            type: 'auth',
            userId: userId
          };
          
          socket.send(JSON.stringify(authMessage));
          addLog(connectionLog, `Sent authentication: User ID = ${userId}`);
        });
        
        // Listen for messages
        socket.addEventListener('message', (event) => {
          try {
            const data = JSON.parse(event.data);
            addLog(messageLog, `Received: ${JSON.stringify(data, null, 2)}`);
          } catch (err) {
            addLog(messageLog, `Received (raw): ${event.data}`);
          }
        });
        
        // Connection closed
        socket.addEventListener('close', (event) => {
          addLog(connectionLog, `Connection closed. Code: ${event.code}, Reason: ${event.reason || 'No reason provided'}`);
          updateConnectionStatus(false);
          socket = null;
        });
        
        // Connection error
        socket.addEventListener('error', (error) => {
          addLog(connectionLog, `Connection error: ${error}`);
          updateConnectionStatus(false);
        });
        
      } catch (err) {
        addLog(connectionLog, `Error creating WebSocket: ${err.message}`);
      }
    });
    
    // Disconnect from server
    disconnectBtn.addEventListener('click', () => {
      if (socket) {
        socket.close();
        addLog(connectionLog, 'Disconnecting...');
      }
    });
    
    // Send message
    sendBtn.addEventListener('click', () => {
      if (!socket || socket.readyState !== WebSocket.OPEN) {
        alert('Not connected to server');
        return;
      }
      
      const recipientId = parseInt(recipientIdInput.value);
      const message = messageInput.value.trim();
      
      if (isNaN(recipientId) || recipientId <= 0) {
        alert('Please enter a valid recipient ID');
        return;
      }
      
      if (!message) {
        alert('Please enter a message');
        return;
      }
      
      try {
        const messageData = {
          type: 'message',
          receiverId: recipientId,
          content: message
        };
        
        socket.send(JSON.stringify(messageData));
        addLog(messageLog, `Sent to User ${recipientId}: ${message}`);
        messageInput.value = '';
      } catch (err) {
        addLog(messageLog, `Error sending message: ${err.message}`);
      }
    });
    
    // Allow sending messages with Enter key
    messageInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter' && !sendBtn.disabled) {
        sendBtn.click();
      }
    });
  </script>
</body>
</html>