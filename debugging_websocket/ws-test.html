<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>WebSocket Test</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      line-height: 1.6;
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
    }
    #connection-status {
      padding: 8px;
      margin-bottom: 15px;
      border-radius: 4px;
      font-weight: bold;
    }
    .connected {
      background-color: #d4edda;
      color: #155724;
    }
    .disconnected {
      background-color: #f8d7da;
      color: #721c24;
    }
    .log-container {
      height: 300px;
      border: 1px solid #ddd;
      padding: 10px;
      overflow-y: scroll;
      margin-bottom: 15px;
      border-radius: 4px;
      background-color: #f8f9fa;
    }
    .controls {
      margin-bottom: 15px;
      display: flex;
      gap: 10px;
    }
    button {
      padding: 6px 12px;
      background-color: #007bff;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    button:hover {
      background-color: #0069d9;
    }
    button:disabled {
      background-color: #6c757d;
      cursor: not-allowed;
    }
    input {
      padding: 6px 12px;
      border: 1px solid #ced4da;
      border-radius: 4px;
      flex-grow: 1;
    }
    .message-form {
      display: flex;
      gap: 10px;
      margin-top: 15px;
    }
    .message-entry {
      margin-bottom: 8px;
      padding: 8px;
      border-bottom: 1px solid #eee;
    }
    .timestamp {
      color: #6c757d;
      font-size: 0.8em;
    }
  </style>
</head>
<body>
  <h1>WebSocket Test</h1>
  
  <div id="connection-status" class="disconnected">Disconnected</div>
  
  <div class="controls">
    <input type="number" id="user-id" placeholder="User ID" value="1">
    <button id="connect-btn">Connect</button>
    <button id="disconnect-btn" disabled>Disconnect</button>
  </div>
  
  <h2>WebSocket Log</h2>
  <div id="log" class="log-container"></div>
  
  <div class="message-controls">
    <h2>Send Message</h2>
    
    <div>
      <input type="number" id="recipient-id" placeholder="Recipient ID" value="2">
    </div>
    
    <div class="message-form">
      <input type="text" id="message-input" placeholder="Type a message">
      <button id="send-btn" disabled>Send</button>
    </div>
  </div>
  
  <script>
    // DOM Elements
    const userIdInput = document.getElementById('user-id');
    const recipientIdInput = document.getElementById('recipient-id');
    const messageInput = document.getElementById('message-input');
    const connectBtn = document.getElementById('connect-btn');
    const disconnectBtn = document.getElementById('disconnect-btn');
    const sendBtn = document.getElementById('send-btn');
    const connectionStatus = document.getElementById('connection-status');
    const logContainer = document.getElementById('log');
    
    // WebSocket reference
    let socket = null;
    
    // Log entry helper
    function addLogEntry(message, isError = false) {
      const entry = document.createElement('div');
      entry.className = 'message-entry';
      
      const now = new Date();
      const timestamp = now.toLocaleTimeString();
      
      entry.innerHTML = `
        <div class="timestamp">[${timestamp}]</div>
        <div class="${isError ? 'text-danger' : ''}">${message}</div>
      `;
      
      logContainer.appendChild(entry);
      logContainer.scrollTop = logContainer.scrollHeight;
    }
    
    // Update connection status
    function updateConnectionStatus(isConnected) {
      connectionStatus.textContent = isConnected ? 'Connected' : 'Disconnected';
      connectionStatus.className = isConnected ? 'connected' : 'disconnected';
      
      connectBtn.disabled = isConnected;
      disconnectBtn.disabled = !isConnected;
      sendBtn.disabled = !isConnected;
    }
    
    // Connect to WebSocket server
    connectBtn.addEventListener('click', () => {
      const userId = parseInt(userIdInput.value);
      
      if (isNaN(userId) || userId <= 0) {
        alert('Please enter a valid User ID');
        return;
      }
      
      try {
        // Get WebSocket URL
        const wsProtocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        const wsHost = window.location.host;
        const wsUrl = `${wsProtocol}//${wsHost}/ws`;
        
        addLogEntry(`Connecting to ${wsUrl}`);
        
        // Create WebSocket connection
        socket = new WebSocket(wsUrl);
        
        // Connection opened
        socket.addEventListener('open', (event) => {
          addLogEntry('Connection established');
          updateConnectionStatus(true);
          
          // Send authentication message
          const authMessage = {
            type: 'auth',
            userId: userId
          };
          
          socket.send(JSON.stringify(authMessage));
          addLogEntry(`Sent authentication: User ID = ${userId}`);
        });
        
        // Connection closed
        socket.addEventListener('close', (event) => {
          addLogEntry(`Connection closed: ${event.reason}`);
          updateConnectionStatus(false);
          socket = null;
        });
        
        // Connection error
        socket.addEventListener('error', (event) => {
          addLogEntry('Connection error', true);
          console.error('WebSocket error:', event);
        });
        
        // Message received
        socket.addEventListener('message', (event) => {
          try {
            const data = JSON.parse(event.data);
            addLogEntry(`Received: ${JSON.stringify(data, null, 2)}`);
          } catch (err) {
            addLogEntry(`Received (raw): ${event.data}`);
          }
        });
        
      } catch (err) {
        addLogEntry(`Error: ${err.message}`, true);
        console.error('WebSocket creation error:', err);
      }
    });
    
    // Disconnect
    disconnectBtn.addEventListener('click', () => {
      if (socket) {
        socket.close();
        addLogEntry('Disconnecting...');
      }
    });
    
    // Send message
    sendBtn.addEventListener('click', () => {
      if (!socket || socket.readyState !== WebSocket.OPEN) {
        alert('Not connected to WebSocket server');
        return;
      }
      
      const recipientId = parseInt(recipientIdInput.value);
      const message = messageInput.value.trim();
      
      if (isNaN(recipientId) || recipientId <= 0) {
        alert('Please enter a valid Recipient ID');
        return;
      }
      
      if (!message) {
        alert('Please enter a message');
        return;
      }
      
      try {
        const messageData = {
          type: 'message',
          receiverId: recipientId,
          content: message
        };
        
        socket.send(JSON.stringify(messageData));
        addLogEntry(`Sent message to User ${recipientId}: ${message}`);
        
        // Clear input field
        messageInput.value = '';
        
      } catch (err) {
        addLogEntry(`Error sending message: ${err.message}`, true);
        console.error('Send message error:', err);
      }
    });
    
    // Allow sending with Enter key
    messageInput.addEventListener('keypress', (event) => {
      if (event.key === 'Enter' && !sendBtn.disabled) {
        sendBtn.click();
      }
    });
    
    // Send an echo test message
    function sendEchoTest() {
      if (!socket || socket.readyState !== WebSocket.OPEN) {
        return;
      }
      
      try {
        const testMessage = {
          type: 'echo',
          content: 'Echo test ' + new Date().toISOString()
        };
        
        socket.send(JSON.stringify(testMessage));
        addLogEntry(`Sent echo test`);
        
      } catch (err) {
        console.error('Echo test error:', err);
      }
    }
  </script>
</body>
</html>